var ErrorMessage={date:"请选择日期",time:"请选择时间",price:"请选择价格",phone:"请输入手机号码",phoneFormat:"请输入正确的手机号码",code:"请输入验证码",name:"请输入姓名",address:"请输入详细地址",email:"请输入邮箱",emailFormat:"请输入正确的邮箱",pay:"请选择支付方式",maxTickets:"没有更多的票啦",id_card:"请填写有效的身份信息",province:"请选择省/直辖市",city:"请选择城市",area:"请选择地区",passport:"请填写有效的护照信息"},Message={},inactiveVoucher={},messageStay=2e3,dateSelected="",top_session="",availDates=utils.parseDate(data),cmInfo={},retriveTimeHandle=null,retriveInterval=60,ticketsInfo,maxTickets,isFree,queryObject=utils.parseQuery(),marketingList=[],marketing=0,discount_num=0,sale_value=0,userDetail="",pay_sign={},order_num,open_id=Cookies.get("wxid")||"";$.each(availDates,function(e){$.extend(cmInfo,zwCalender.getMonthDays(e))}),$("body").on("tap",".zw-protocol-radio",function(){$(this).hasClass("checked")?$(this).removeClass("checked"):$(this).addClass("checked")}),$("body").on("tap",".zw-protocol-btn",function(){$("#zw-protocol-pop-up").fadeIn(200),$("body").addClass("noscroll")}),$("body").on("tap",".zw-protocol-pop-up-close",function(){$("#zw-protocol-pop-up").fadeOut(200),$("body").removeClass("noscroll")});var cs="",currentYear,currentMonth,preMonth,nextMonth;$.each(cmInfo,function(e,t){var s,a,o,i,n="";a=e.substr(0,4),o=e.substr(4),n+="<h3>"+a+"年"+o+"月</h3>",n+='<div class="zw-order-date-detail">';var s=availDates[e]||[];$.each(t,function(e,t){i=a+"-"+o+"-"+utils.zeroPadding(t,2),(e+1)%7==1&&(n+="<ul>"),n+=-1!==s.indexOf(t)?'<li class="available" ':'<li class="go" ',0==t&&(t="",i=""),n+='year="'+a+'" month="'+o+'" date="'+t+'" time-string="'+i+'"><span>'+t+"</span></li>",(e+1)%7==0&&(n+="</ul>")}),n+="</div>",cs+=n}),$(".zw-order-month-wrap").html(cs),$(".zw-order-month-wrap .available").on("tap",function(){$(".zw-order-month-wrap .cur").removeClass("cur");var e=$(this);e.addClass("cur");var t=e.attr("time-string"),s=utils.getLocalDateString(t);dateSelected=t,$("#selectDate").text(s),$(".zw-order-date").addClass("bottom"),getTicketsInfo(),$(".payfor").html('<span style="color:#6b6b6b;">合计</span>'),$("#selectDate").addClass("selected"),setTimeout(function(){switchBody(1)},600)});var getRegion=function(){var e=$("[name=province] option:selected").text(),t=$("[name=city] option:selected").text(),s=$("[name=area] option:selected").text();return e+t+s},getPageData=function(){var e={};return $(".zw-enjoy-body").find("input:not(.inactive),select:not(.inactive)").each(function(){var t=$(this),s=t.attr("name"),a=$.trim(t.val());s&&a&&("address"==s?e[s]=getRegion()+a:e[s]=a)}),e.play_time=dateSelected,e.is_wap=1,e.top_session=top_session,e.voucher=voucher_type,_.each(["paysource","cmbsource","zmsource","cooper"],function(t){queryObject[t]&&(e.source_type="paysource"==t?"unionpay":"cmbsource"==t?"cmbchina":"zmsource"==t?"share":"cooperation",e.source_id=queryObject[t].length>30?queryObject[t].substr(0,30):queryObject[t])}),use_coupon>0?("success"==coupon.status&&coupon.result.coupon_id>0?e.coupon_id=coupon.result.coupon_id:e.convert_code=convert_code,e):(marketing&&(e.marketing_id=marketing.id),discount_num&&(e.discount_num=discount_num),e)};1==any_time?setTimeout(function(){$(".zw-order-date .available:last").trigger("tap"),$("#sDate,#sTime").hide(),$("#sAnytime").show(),$("#sAnytime .zw-enjoy-active-date").height()<20&&$("#sAnytime .zw-enjoy-active-date").css("paddingTop","15px")},0):1==data.length&&setTimeout(function(){$(".zw-order-date .available:last").trigger("tap")},0),$(".zw-enjoy-getvarify-submit").on("tap",function(){var e=$(this);if(!e.hasClass("processing")){e.addClass("processing"),trackEvent(["_trackEvent","mpay手机验证","点击",id]);var t=$.trim($(".zw-enjoy-getvarify-text").val());if(!t)return utils.showMsg(ErrorMessage.code,messageStay),$(".zw-enjoy-getvariy-text").focus(),void e.removeClass("processing");var s=$.trim($("[name=phone]").val());checkEms(s,t,function(t){t?(toggleLoading(),utils.showMsg(t,messageStay),$(".varifymsg").removeClass("color-ae").text("验证失败，请重新输入！").focus(),e.removeClass("processing")):($(".zw-enjoy-alert-varify").addClass("right"),retriveTimeHandle&&(clearTimeout(retriveTimeHandle),retriveTimeHandle=null),toggleLoading(1),$.post("/proxy?api_path=/order/create&v=3.0&fields_version=3.3&top_session="+top_session,getPageData(),"json").then(function(e){toggleLoading(),submitUnlock(),toggleReadonly(),$("#backdrop").addClass("displaynone"),$(".zw-enjoy-getvarify-text").val(""),console.log(e),"success"==e.status?(order_num=e.result.order_num,payInfo()):(e.result&&601==e.result.error_code&&clearSession(),utils.showMsg(e.result.error_msg,messageStay))}).fail(function(e){toggleLoading(),toggleReadonly()}).always(function(){e.removeClass("processing")}))})}});var noverifySubmit=function(){top_session&&(toggleLoading(1),$("#backdrop").removeClass("displaynone"),$.post("/proxy?api_path=/order/create&v=3.0&fields_version=3.3&top_session="+top_session,getPageData(),"json").then(function(e){console.log(e),toggleLoading(),submitUnlock(),toggleReadonly(),$("#backdrop").addClass("displaynone"),utils.showMsg(e.result.error_msg,messageStay),"success"==e.status?(order_num=e.result.order_num,payInfo()):(e.result&&601==e.result.error_code&&clearSession(),utils.showMsg(e.result.error_msg,messageStay))}).fail(function(e){toggleLoading(),submitUnlock(),toggleReadonly(),$("#backdrop").addClass("displaynone"),utils.showMsg(res.result.error_msg,messageStay)}))},keep2=function(e){return parseInt(100*e)/100},round2=function(e,t){var s=Math.pow(10,t);return Math.floor(e*s*10)%5==0&&Math.floor(e*s*10)==e*s*10&&Math.floor(e*s)%2==0?Math.floor(e*s)/s:Math.round(e*s)/s},clearMarketing=function(){marketing=0,marketingList=[],discount_num=0,setMarketing()},resetMarketing=function(){marketing=0,discount_num=0,marketingList.length>0&&($(".zw-yh").show().find(".zw-yh-price").text(marketingList.length+"个优惠").css("color","#aeaeae"),$(".zw-pay-preferential-use.choosed").removeClass("choosed"))},setMarketing=function(){var e=marketingList.length;if(e>0){$(".zw-yh").show().find(".zw-yh-price").text(e+"个优惠");var t="";_.each(marketingList,function(e){var s=0==e.available?"nouse":"use";t+='<li><div class="zw-pay-preferential-'+s+' clearfix" marketing-id="'+e.id+'"><div class="fleft zw-pay-con"><p class="yhP"><span>'+e.title_discount+"</span></p><p>"+e.info_res+'</p></div><span class="zw-pay-price fright"></span></div></li>'}),$(".zw-pay-preferential-list ul").html(t)}else $(".zw-yh").hide().find(".zw-yh-price").text(""),$(".zw-pay-preferential-list ul").html("")},checkMarketing=function(e){e=e||$("[name=ticket_id]").val(),0!=needCheckMarketing&&e&&$.get("/proxy",{api_path:"/activity/"+id+"/marketing",ticket_id:e,v:"3.0",fields_version:"3.3"},"json").then(function(e){"success"==e.status&&e.result.list.length>0?(marketingList=e.result.list,setMarketing(),setTimeout(function(){1==marketingList.length&&$(".zw-pay-preferential-use:first").trigger("tap")},0)):(marketing=0,discount_num=0,marketingList=[],clearMarketing())}).fail(function(e){console.log(e)})},calculatePrice=function(){var e=$.trim($(".zw-enjoy-order-msg-num").val()),t=$(".price-list .cur").attr("data-val"),s=+$("[name=pay_type]").val();t=Math.max(t,0);var a=e*t;if(e>0&&t>-1){var o=e*t;if(marketing){var i=marketing.available,n=[];if(_.each(marketing.pay_limit,function(e){n.push(+e.pay_type)}),0==n.length||n.length>0&&n.indexOf(s)>-1){var r,c,l,d,u,p=marketing.discount[0];p.indexOf("*")>-1?(p=p.split("*"),r=p[0]>0?3:1,l=p[0],c=p[1]):p.indexOf("-")>-1&&(p=p.split("*"),r=2,c=p[1],l=p[0]),(r=1)?i>=e?(d=e*t*c/100,u=0,discount_num=e):(d=i*t*c/100,u=(e-i)*t,discount_num=i):2==r?i>=e?(d=e*t,d=d>=l?d-c:d,u=0,discount_num=e):(d=i*t,d=d>=l?d-c:d,u=(e-i)*t,discount_num=i):3==r&&(i>=e?(d=e*t,d=d>=l?d*c/100:d,u=0,discount_num=e):(d=i*t,d=d>=l?d*c/100:d,u=(e-i)*t,discount_num=i)),o=d+u}}use_coupon>0&&"success"==coupon.status&&coupon.result&&coupon.result.amount&&(o=Math.max(0,o-coupon.result.amount)),o=round2(o,2),0==o?isFree=1:($(".payfor").text("￥"+o),isFree=0),1==raw.result.is_free?$(".payfor").text("免费"):($(".payfor").html('<span style="color:#6b6b6b;">合计</span>￥'+o),sale_value=round2(a-o,2))}marketing&&$(".zw-yh-price").text("-￥"+sale_value)};$("body").on("tap",".zw-yh",function(){return $("#selectPrice").hasClass("selected")?($("input:focus").blur(),$(".zw-pay-preferential").removeClass("right"),toggleReadonly(1),void setTimeout(function(){$("body").addClass("noscroll")},600)):void utils.showMsg("请选择价格",2e3)}),$("body").on("tap",".zw-pay-preferential .close",function(){$(".zw-pay-preferential").addClass("right"),toggleReadonly(),$("body").removeClass("noscroll")}),$("body").on("tap",".zw-pay-preferential-use",function(){var e,t=$(this),s=t.attr("marketing-id");t.hasClass("choosed")?resetMarketing():($(".zw-pay-preferential-use.choosed").removeClass("choosed"),t.addClass("choosed"),marketing=_.find(marketingList,function(e){return e.id==s}),$(".zw-pay-preferential").addClass("right"),$(".zw-yh-price").css("color","#6b6b6b"),$(".zw-choose-payway em").each(function(){$(this).removeClass("tag").text("")}),marketing.pay_limit.length>0&&(_.each(marketing.pay_limit,function(e){var t=$(".zw-enjoy-payway[pay_type="+e.pay_type+"]").parents(".zw-choose-payway");t.find("em").text(e.pay_tip).addClass("tag")}),e=marketing.pay_limit[0].pay_type,e=$("[pay_type="+e+"]"),e.hasClass("choosed")||e.trigger("tap")),toggleReadonly(),$("body").removeClass("noscroll")),calculatePrice()}),$(".numMinus").on("tap",function(){var e=$(this).find(".zw-enjoy-order-msg-minus");if(!e.attr("disabled")){var t=$(".zw-enjoy-order-msg-num"),s=$.trim(t.val());s-=0,s=parseInt(s),s&&s>1?s--:s=1,t.val(s),1==s&&e.attr("disabled","disabled"),maxTickets&&maxTickets>1&&$(".zw-enjoy-order-msg-plus").removeAttr("disabled"),calculatePrice()}}),$(".numPlus").on("tap",function(){var e=$(this).find(".zw-enjoy-order-msg-plus"),t=$(".zw-enjoy-order-msg-num"),s=$.trim(t.val());return s-=0,e.attr("disabled")?void(maxTickets&&s&&s>=maxTickets&&(t.val(maxTickets),utils.showMsg("最多预订"+maxTickets+"张",messageStay))):maxTickets&&s>=maxTickets?(t.val(maxTickets),utils.showMsg("最多预订"+maxTickets+"张",messageStay),void $(".zw-enjoy-order-msg-plus").attr("disabled","disabled")):(s=parseInt(s),s||(s=0),s++,maxTickets&&(s=Math.min(maxTickets,s)),t.val(s),s>1&&$(".zw-enjoy-order-msg-minus").removeAttr("disabled"),void calculatePrice())});var switchBody=function(e,t){e?($("body").removeClass("noscroll"),t||$("#backdrop").addClass("displaynone"),toggleReadonly()):($("input:focus").blur(),t||$("#backdrop").removeClass("displaynone"),$("body").addClass("noscroll"),toggleReadonly(1))};$("#sDate").on("tap",function(){$(".zw-order-date").removeClass("bottom"),switchBody()}),$(".zw-order-date-close").on("tap",function(){var e=$(".zw-order-date");e.hasClass("bottom")||(e.addClass("bottom"),setTimeout(function(){switchBody(1)},600))}),$("#sTime").on("tap",function(){return $("#selectDate").hasClass("selected")?($(".zw-order-time").removeClass("bottom"),void switchBody()):void utils.showMsg("请选择日期",2e3)}),$(".zw-order-time-close").on("tap",function(){var e=$(".zw-order-time");e.hasClass("bottom")||(e.addClass("bottom"),setTimeout(function(){switchBody(1)},600))}),$("#sPrice").on("tap",function(){return $("#selectDate").hasClass("selected")?$("#selectTime").hasClass("selected")?($(".zw-order-price").removeClass("bottom"),void switchBody()):void utils.showMsg("请选择时间",2e3):void utils.showMsg("请选择日期",2e3)}),$(".zw-order-price-close").on("tap",function(){var e=$(".zw-order-price");e.hasClass("bottom")||(e.addClass("bottom"),setTimeout(function(){switchBody(1)},600))});var feedVoucherInfo=function(){if($(".zw-enjoy-order-person").find(".voucher-info").each(function(){var e=$(this).find("input:first").attr("name");inactiveVoucher[e]=$(this).remove()}),voucher&&voucher.info&&voucher.info.length>0){var e="";_.each(voucher.info,function(t){var s=inactiveVoucher[t.key],a="number"==t.type?"tel":"text";s?$(".zw-enjoy-order-person").append(s):e+="address"==t.key?'<div class="shared-info voucher-info" ><li ><span>'+t.name+'</span><div class="zw-enjoy-order-person-input"><div class="select-cities"><div class="city-select-wrap"><select name="province" class="inactive"><option value="-1">省/直辖市</option></select></div><div class="city-select-wrap"><select name="city" class="inactive"><option value="-1">城市</option></select></div><div class="city-select-wrap"><select name="area" class="inactive"><option value="-1">地区</option></select></div></div></div><div class="" style="clear:both;"></div></li><li><span>详细地址</span><div class="zw-enjoy-order-person-input"><input class="required" type="text" name="'+t.key+'" placeholder="填写地址" /></div></li><script src="'+choseCityJs+'"></script></div>':"credential"==t.key?'<div class="shared-info voucher-info" ><li ><span>'+t.name+'</span><div class="zw-enjoy-order-person-input select-credential">身份证</div><em class="zw-enjoy-rightarrow select-credential-arrow"></em></li><li><span>证件号码</span><div class="zw-enjoy-order-person-input"><input class="required credential" type="text" name="id_card" placeholder="请填写有效的身份信息" /></div></li></div>':'<li class="shared-info voucher-info"><span>'+t.name+'</span><div class="zw-enjoy-order-person-input"><input class="required" type="'+a+'" value="" name="'+t.key+'" placeholder="'+t.tip+'" /></div></li>'}),e&&$(".zw-enjoy-order-person").append(e)}};$("body").on("tap",".select-credential",function(){$("#zw-choose-access").removeClass("bottom"),switchBody()}),$("body").on("tap",".zw-choose-access-close",function(){var e=$("#zw-choose-access");e.hasClass("bottom")||(e.addClass("bottom"),setTimeout(function(){switchBody(1)},600))}),$("body").on("tap",".access",function(){var e,t,s,a=$(this);$(".access.cur").removeClass("cur"),a.addClass("cur"),e=a.attr("data-key"),t=a.attr("data-tip"),s=a.attr("data-type");var o=$("#zw-choose-access");o.hasClass("bottom")||(o.addClass("bottom"),setTimeout(function(){switchBody(1)},600));var i=$(".credential");i.attr("name")!=e&&($(".select-credential").text(s),i.attr("name",e),i.attr("placeholder",t),i.val(""))}),$("body").on("tap",".selectVoucher",function(){$(".zw-order-evidence").removeClass("bottom"),switchBody()}),$("body").on("tap",".zw-order-evidence-close",function(){var e=$(".zw-order-evidence");e.hasClass("bottom")||(e.addClass("bottom"),setTimeout(function(){switchBody(1)},600))}),$("body").on("tap",".voucher-wrap",function(){var e,t,s=$(this);$(".voucher-wrap.cur").removeClass("cur"),s.addClass("cur"),e=s.attr("data-title"),t=s.attr("data-type"),voucher=_.find(vouchers,function(e){return e.type==t}),voucher_type=t,feedVoucherInfo(),$("#validate").text(e);var a=$(".zw-order-evidence");a.hasClass("bottom")||(a.addClass("bottom"),setTimeout(function(){switchBody(1)},600))}),$(".selectCoupon:not(.fixed)").on("tap",function(){if(!$("#selectPrice").hasClass("selected"))return void utils.showMsg("请选择价格",2e3);var e=$.trim($("[name=phone]").val());return e?utils.isMobile(e)?($("input:focus").blur(),$(".zw-usecoupon").removeClass("right"),toggleReadonly(1),void setTimeout(function(){$("body").addClass("noscroll")},600)):void utils.showMsg(ErrorMessage.phoneFormat,messageStay):void utils.showMsg(ErrorMessage.phone,messageStay)}),$("body").on("tap",".zw-nousecoupon-btn",function(){use_coupon=0,resetCoupon("使用券码"),$("[name=usecoupon]").val(""),needCheckMarketing=hasMarketing,needCheckMarketing&&checkMarketing(),$(".zw-usecoupon-close").trigger("tap"),calculatePrice()}),$("body").on("tap",".zw-usecoupon-close",function(){var e=$(".zw-usecoupon");e.hasClass("right")||($("input:focus").blur(),e.addClass("right"),toggleReadonly(),$("body").removeClass("noscroll"))}),$("body").on("tap",".zw-usecoupon-btn",function(){var e=$.trim($("[name=usecoupon]").val());return e?(convert_code=e,use_coupon=1,void checkcoupon(function(e,t){e?(utils.showMsg(e,messageStay),use_coupon=0,resetCoupon("使用券码"),needCheckMarketing=hasMarketing,needCheckMarketing&&checkMarketing()):(coupon=t,setCoupon(),$("input:focus").blur(),$(".zw-usecoupon").addClass("right"),toggleReadonly(),$("body").removeClass("noscroll"),needCheckMarketing=0,clearMarketing(),calculatePrice())})):void utils.showMsg("请输入券码",messageStay)});var setCoupon=function(){"success"==coupon.status&&$("#usecoupon_id").html(coupon.result.title+' <i class="color-red" style="font-style:normal;">-￥'+coupon.result.amount+"</i>").css("color","#6b6b6b")},resetCoupon=function(e){$("#usecoupon_id").html(e||"").css("color","#aeaeae")},checkcoupon=function(e){var t=$.trim($("[name=phone]").val()),s=convert_code,a=$("[name=ticket_id]").val(),o=$.trim($("[name=num]").val());t&&0!=s&&a&&$.get("/order/checkcoupon",{p:utils.n2s(t),c:s,id:utils.n2s(id),t:utils.n2s(a),n:utils.n2s(o)},"json").then(function(t){"success"==t.status?e&&e(null,t):e&&e(t.result.error_msg||"服务器出小差了~")}).fail(function(t){console.log(t),e&&e("连接服务器失败")})},submitLock=function(){$(".zw-enjoy-msg-submit").addClass("processing")},submitUnlock=function(){$(".zw-enjoy-msg-submit").removeClass("processing")};$(".zw-enjoy-order-msg-num").on("blur",function(e){var t=$(this),s=$.trim(t.val());/^\d+$/.test(s)?(s-=0,maxTickets&&s>maxTickets&&(s=maxTickets,utils.showMsg("最多预订"+maxTickets+"张",messageStay),$(".zw-enjoy-order-msg-plus").attr("disabled","disabled"))):s=1,t.val(s),s>1&&$(".zw-enjoy-order-msg-minus").removeAttr("disabled"),calculatePrice()}),$(".zw-enjoy-order-msg-num").on("keyup",function(e){var t=$(this),s=$.trim(t.val());s&&(/^\d+$/.test(s)?(s-=0,maxTickets&&s>maxTickets&&(t.val(maxTickets),utils.showMsg("最多预订"+maxTickets+"张",messageStay),$(".zw-enjoy-order-msg-plus").attr("disabled","disabled"))):t.val(1))}),$(".zw-enjoy-msg-submit").on("tap",function(e){$(this).hasClass("processing")||(trackEvent(["_trackEvent","mpay确认按钮","点击",id]),submitLock(),pageVarify()?($("input:focus").blur(),userDetail&&userDetail.mobile==$.trim($("[name=phone]").val())&&top_session?noverifySubmit():checkMobile()):submitUnlock())}),$(".zw-enjoy-getvarify").on("tap",function(e){$(this).attr("ticking")||checkMobile()}),$("body").on("tap",".time-list li",function(e){$(".time-list .cur").removeClass("cur");var t=$(this),s=t.attr("data-val");t.addClass("cur"),renderPricelist(s),$("input[name=schedule_id]").val(s),$("#selectTime").text(t.find(".zw-time-fw").text()).addClass("selected"),$(".zw-order-time").addClass("bottom"),setTimeout(function(){switchBody(1)},600)}),$("body").on("tap",".price-list li:not(.fixed)",function(e){$(".price-list .cur").removeClass("cur");var t=$(this),s=t.attr("ticket-name");maxTickets=t.attr("data-avail")-0,tid=t.attr("ticket-id"),maxTickets&&$(".zw-enjoy-order-msg-plus").removeAttr("disabled"),tid&&$("[name=ticket_id]").val(tid);var a=t.attr("data-val");$.trim($(".zw-enjoy-order-msg-num").val());t.addClass("cur"),0==a?(a="免费",isFree=1):(a="￥"+a,isFree=0),$("#selectPrice").text(a+" "+s).addClass("selected"),$(".zw-order-price").addClass("bottom"),calculatePrice(),checkMarketing(tid),checkcoupon(function(e,t){e?(use_coupon=0,resetCoupon(e||"该票种不能使用此券码")):(coupon=t,use_coupon=1,setCoupon()),calculatePrice()}),setTimeout(function(){switchBody(1)},600)}),$(".zw-enjoy-getvarify-cancel").on("tap",function(){toggleReadonly(),submitUnlock(),$(".zw-enjoy-alert-varify").addClass("right"),$(".varifymsg").text(""),$(".zw-enjoy-getvarify-text").val(""),setTimeout(function(){$("#backdrop").addClass("displaynone")},100),retriveTimeHandle&&(clearTimeout(retriveTimeHandle),retriveTimeHandle=null),$(".zw-enjoy-getvarify").text("重新获取").removeAttr("ticking")});var checkMobile=function(){var e=$.trim($("[name=phone]").val());return e?utils.isMobile(e)?void sendSms(e,function(t){t?(utils.showMsg(t,messageStay),submitUnlock()):(toggleReadonly(1),$("#backdrop").removeClass("displaynone"),$(".zw-enjoy-alert-varify").removeClass("right"),$(".varifymsg").addClass("color-ae").text("验证码已发送到"+e),countDown())}):void utils.showMsg(ErrorMessage.phoneFormat,messageStay):void utils.showMsg(ErrorMessage.phone,messageStay)};$("body").on("tap",".zw-choose-payway:not(.fixed)",function(){var e=$(this),t=e.find(".zw-enjoy-payway");t.hasClass("choosed")?($("#pay_type").val(0),t.removeClass("choosed"),calculatePrice()):($(".zw-choose-payway").find(".zw-enjoy-payway").removeClass("choosed"),$("#pay_type").val(t.attr("pay_type")),t.addClass("choosed"),calculatePrice())});var pageVarify=function(){if(!dateSelected)return utils.showMsg(ErrorMessage.date,messageStay),!1;if(!$("[name=schedule_id]").val())return utils.showMsg(ErrorMessage.time,messageStay),!1;if(!$("[name=ticket_id]").val())return utils.showMsg(ErrorMessage.price,messageStay),!1;var e,t,s=!0;return $("input.required:not(.inactive)").each(function(){var a=$(this),o=$.trim(a.val()),i=a.attr("name");return"address"==i&&_.each(["province","city","area"],function(e){-1==$("[name="+e+"]").val()&&(s=!1,t||(t=ErrorMessage[e]))}),o?("phone"!=i||utils.isMobile(o)||(s=!1,e||(e=a),t||(t=ErrorMessage.phoneFormat)),"email"!=i||utils.isEmail(o)||(s=!1,e||(e=a),t||(t=ErrorMessage.emailFormat)),"id_card"!=i||utils.isIdCard(o)||(s=!1,e||(e=a),t||(t=ErrorMessage.id_card)),void("passport"!=i||utils.isPassport(o)||(s=!1,e||(e=a),t||(t=ErrorMessage.passport)))):(s=!1,e||(e=a),void(t||(t=ErrorMessage[i])))}),t&&utils.showMsg(t,messageStay),s?isFree||"0"!=$("#pay_type").val()?$(".zw-protocol-radio").length>0&&!$(".zw-protocol-radio").hasClass("checked")?(utils.showMsg("请接受《Slide the City》购买须知才能购买哟",messageStay),!1):!0:(utils.showMsg(ErrorMessage.pay,messageStay),!1):s},renderTimelist=function(){if(ticketsInfo&&ticketsInfo.length>0){var e="";$.each(ticketsInfo,function(t,s){e+='<li data-end-time="'+s.time_end+'" data-start-time="'+s.time_start+'" data-val="'+s.id+'" ><div class="zw-time-icon"></div><div class="zw-time-fw">'+s.time_start+"—"+s.time_end+"</div></li>"}),$(".time-list").html(e),$(".price-list").html(""),1==ticketsInfo.length?$(".time-list li:first").trigger("tap"):($("#selectTime").removeClass("selected").text("选择时间"),$("#selectPrice").removeClass("selected").text("选择价格"),$("[name=schedule_id]").val(""),$("[name=ticket_id]").val(""))}else $(".time-list").html(""),$(".price-list").html(""),$("#selectTime").removeClass("selected").text("选择时间"),$("#selectPrice").removeClass("selected").text("选择价格"),$("input[name=schedule_id]").val(""),$("input[name=ticket_id]").val("")},renderPricelist=function(e){var t,s="";$.each(ticketsInfo,function(s,a){a.id==e&&(t=a)}),$.each(t.ticket,function(e,t){var a=t.price;a=0==a?"免费":"￥"+a;var o=""==t.des?'style="padding-top:10px;"':"";s+=t.available>0?'<li ticket-name="'+t.name+'" ticket-id="'+t.id+'" data-avail="'+t.available+'" data-val="'+t.price+'" ><div class="zw-price-icon"></div><div class="con"><h5 '+o+">"+t.name+"</h5><p>"+t.des+'</p></div><div class="fright price">'+a+"</div></li>":'<li class="fixed" ticket-id="'+t.id+'" data-avail="'+t.available+'" data-val="'+t.price+'" ><div class="zw-price-icon"></div><div class="zw-nocon"><h5 '+o+' class="clearfix"><span class="fleft">已抢光</span>'+t.name+"</h5><p>"+t.des+'</p></div><div class="fright price">'+a+"</div></li>"}),$(".price-list").html(s),1==t.ticket.length?setTimeout(function(){$(".price-list li:first").trigger("tap")},0):($("#selectPrice").removeClass("selected").text("选择价格"),$("[name=ticket_id]").val(""))},countDown=function(){function e(){s++<retriveInterval?(retriveTimeHandle=setTimeout(e,1e3),t=retriveInterval-s,$(".zw-enjoy-getvarify").text("("+t+")重新获取")):(retriveTimeHandle=null,$(".zw-enjoy-getvarify").text("重新获取").removeAttr("ticking"))}retriveTimeHandle&&clearTimeout(retriveTimeHandle),$(".zw-enjoy-getvarify").attr("ticking","true");var t,s=0;e()},getTicketsInfo=function(){$("#backdrop").removeClass("displaynone"),$("#spinnerWrap").removeClass("displaynone"),$.get("/proxy",{api_path:"/product/list",activity_id:id,date:dateSelected,v:"3.0",fields_version:"3.3"}).then(function(e){if("string"==typeof e)try{e=$.parseJSON(e)}catch(t){}ticketsInfo="success"==e.status&&e.result.list.length>0?e.result.list:[],renderTimelist(),$(".zw-enjoy-order-msg-minus, .zw-enjoy-order-msg-plus").attr("disabled","1"),$(".zw-enjoy-order-msg-num").val(1)}).fail(function(e){}).always(function(){$("#backdrop").addClass("displaynone"),$("#spinnerWrap").addClass("displaynone"),$("body").removeClass("noscroll")})},toggleLoading=function(e){e?$("#spinnerWrap").removeClass("displaynone"):$("#spinnerWrap").addClass("displaynone")},toggleReadonly=function(e){e?$(".zw-enjoy-container input[type=text], .zw-enjoy-container input[type=tel]").each(function(){$(this).prop("readonly",!0)}):$(".zw-enjoy-container input[type=text], .zw-enjoy-container input[type=tel]").each(function(){$(this).prop("readonly",!1)})},sendSms=function(e,t){toggleLoading(1),$.get("/order/mobilebindcode",{p:utils.n2s(e)},"json").then(function(e){t("success"==e.status?null:"E_USER_MOBILE_SEND_INTEVAL"==e.result.error_code?null:e.result.error_msg)}).fail(function(e){}).always(function(){toggleLoading()})},checkEms=function(e,t,s){toggleLoading(1),$.get("/order/mobilebind",{p:utils.n2s(e),c:utils.n2s(t)},"json").then(function(e){"success"==e.status?(top_session=e.result.top_session,Cookies.set("MBSESSID",top_session,{expires:31536e3}),getUserDetails(e.result.top_session),s(null)):s(e.result.error_msg)}).fail(function(e){toggleLoading()})},switchOrderPage=function(){var e="/order/"+order_num,t="?activity="+id;sticky&&(t+="&"+sticky),location=e+t},payZero=function(){$("#backdrop").removeClass("displaynone"),toggleLoading(1),$.post("/proxy"+utils.obj2qs({api_path:"/order/verify",top_session:top_session}),{order_num:order_num,sign_str:"",is_wap:1},"json").then(function(e){"success"==e.status?switchOrderPage():utils.showMsg(e.result.err_msg,3e3)}).fail(function(e){utils.showMsg("checkPay: failed",3e3)}).always(function(){$("#backdrop").addClass("displaynone"),toggleLoading()})},jsApiCall=function(){WeixinJSBridge.invoke("getBrandWCPayRequest",pay_sign,function(e){if(WeixinJSBridge.log(e.err_msg),"get_brand_wcpay_request:ok"==e.err_msg)$("#backdrop").removeClass("displaynone"),toggleLoading(1),$.post("/proxy"+utils.obj2qs({api_path:"/order/verify",top_session:top_session}),{order_num:order_num,sign_str:e.err_msg,is_wap:1},"json").then(function(e){"success"==e.status?switchOrderPage():utils.showMsg(e.result.err_msg,3e3)}).fail(function(e){utils.showMsg("checkPay: failed",3e3)}).always(function(){$("#backdrop").addClass("displaynone"),toggleLoading()});else if("get_brand_wcpay_request:cancel"==e.err_msg){try{}catch(t){}switchOrderPage()}else if("get_brand_wcpay_request:fail"==e.err_msg){try{}catch(t){}switchOrderPage()}})},callpay=function(){"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",jsApiCall,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",jsApiCall),document.attachEvent("onWeixinJSBridgeReady",jsApiCall)):jsApiCall()},postPay=function(){var e=document.createElement("form");e.setAttribute("method","post"),e.setAttribute("action",pay_sign.url);for(var t in pay_sign.data)if(pay_sign.data.hasOwnProperty(t)){var s=document.createElement("input");s.setAttribute("type","hidden"),s.setAttribute("name",t),s.setAttribute("value",pay_sign.data[t]),e.appendChild(s)}document.body.appendChild(e),e.submit()},payInfo=function(){return isFree?void payZero():($("#backdrop").removeClass("displaynone"),toggleLoading(1),void $.post("/proxy"+utils.obj2qs({api_path:"/order/payinfo",top_session:top_session}),{order_num:order_num,openid:open_id,is_wap:1},"json").then(function(e){if("success"!=e.status)return void alert(e.result.error_msg||"调起支付失败");if("1"==e.result.pay_sign.pay_type)window.location.href=e.result.pay_sign.order_string;else if("2"==e.result.pay_sign.pay_type){pay_sign.appId=e.result.pay_sign.appid,pay_sign.timeStamp=e.result.pay_sign.timestamp+"",pay_sign.nonceStr=e.result.pay_sign.nonce_str,pay_sign["package"]=e.result.pay_sign["package"],pay_sign.signType=e.result.pay_sign.sign_type,pay_sign.paySign=e.result.pay_sign.sign;try{}catch(t){}callpay()}else pay_sign=e.result.pay_sign,postPay()}).always(function(){$("#backdrop").addClass("displaynone"),toggleLoading()}))},getUserDetails=function(e){0==use_coupon&&e&&$.get("/proxy",{api_path:"/user/detail",top_session:e}).then(function(t){"success"==t.status&&utils.isMobile(t.result.mobile)?(top_session=e,userDetail=t.result,$.trim($("[name=phone]").val())||$("[name=phone]").val(t.result.mobile)):t.result&&601==t.result.error_code&&clearSession()}).fail(function(e){})},clearSession=function(){Cookies.set("MBSESSID",""),top_session="",userDetail=""};$(function(){$(".zw-choose-payway.fixed").appendTo(".payways"),utils.isMobile(phone)&&$("[name=phone]").val(phone).prop("disabled",!0);var e=Cookies.get("MBSESSID")||"";getUserDetails(e),errorMsg&&utils.showMsg(errorMsg,5e3),$(".voucher-wrap").length>0&&$(".voucher-wrap:first").trigger("tap"),$(".zw-choose-payway").length>0&&$(".zw-choose-payway:first").trigger("tap");var t=sticky?"?activity="+id+"&"+sticky:"?activity="+id;Cookies.set("ordersticky",t)});